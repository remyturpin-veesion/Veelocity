# v0.4 Linear Integration & Development Metrics Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Connect to Linear API, sync teams and issues, calculate development metrics (PR Review Time, Cycle Time, Throughput), link PRs to issues, complete the dashboard.

**Architecture:** LinearConnector uses Linear GraphQL API. LinearTeam/LinearIssue models store data. DevelopmentMetricsService calculates PR Review Time, Cycle Time, Throughput. PR-Issue linking via branch name/title parsing.

**Tech Stack:** httpx (GraphQL calls to Linear API), regex (issue identifier parsing)

---

## Task 1: Add Linear Models

**Files:**
- Create: `backend/app/models/linear.py`
- Modify: `backend/app/models/__init__.py`
- Create: `backend/alembic/versions/xxxx_add_linear_models.py`

**Models:**

```python
# LinearTeam
- id, linear_id (unique), name, key
- created_at, updated_at

# LinearIssue  
- id, linear_id (unique), team_id (FK)
- identifier (e.g., "ENG-123"), title
- state, priority, assignee_name
- created_at, started_at, completed_at, canceled_at
- linked_pr_id (FK to pull_requests, nullable)
```

---

## Task 2: Create LinearConnector

**Files:**
- Create: `backend/app/connectors/linear.py`
- Modify: `backend/app/connectors/factory.py`
- Create: `backend/tests/connectors/test_linear.py`

**GraphQL Queries:**
- Fetch teams: `{ teams { nodes { id name key } } }`
- Fetch issues: `{ issues(filter: {...}) { nodes { id identifier title state { name } priority assignee { name } createdAt startedAt completedAt canceledAt } } }`

---

## Task 3: Create SyncLinearService

**Files:**
- Create: `backend/app/services/sync_linear.py`
- Create: `backend/tests/services/test_sync_linear.py`

**Features:**
- Upsert teams
- Upsert issues with state mapping
- Link issues to PRs via identifier matching

---

## Task 4: Add PR-Issue Linking Logic

**Files:**
- Create: `backend/app/services/linking.py`

**Logic:**
1. Parse branch name for pattern: `feature/ENG-123-*`, `fix/ENG-123-*`
2. Parse PR title/body for pattern: `ENG-123`, `[ENG-123]`
3. Match to LinearIssue.identifier
4. Update LinearIssue.linked_pr_id

---

## Task 5: Add Linear API Endpoints

**Files:**
- Create: `backend/app/api/v1/endpoints/linear.py`
- Modify: `backend/app/api/v1/router.py`

**Endpoints:**
- `GET /linear/teams` - List teams
- `GET /linear/issues` - List issues with filters (team_id, state, linked)

---

## Task 6: Create DevelopmentMetricsService

**Files:**
- Create: `backend/app/services/metrics/development.py`
- Modify: `backend/app/services/metrics/__init__.py`

**Metrics:**

### PR Review Time
Time from PR opened to first review.
```python
review_time = first_review.submitted_at - pr.created_at
```

### PR Merge Time
Time from PR opened to merged.
```python
merge_time = pr.merged_at - pr.created_at
```

### Cycle Time
Time from issue started to linked PR merged.
```python
cycle_time = pr.merged_at - issue.started_at
```

### Throughput
Count of PRs merged / issues completed per period.

---

## Task 7: Add Development Metrics API Endpoints

**Files:**
- Modify: `backend/app/api/v1/endpoints/metrics.py`

**New Endpoints:**
- `GET /metrics/development` - All development metrics
- `GET /metrics/development/pr-review-time`
- `GET /metrics/development/pr-merge-time`
- `GET /metrics/development/cycle-time`
- `GET /metrics/development/throughput`

---

## Task 8: Update Connectors Sync

**Files:**
- Modify: `backend/app/api/v1/endpoints/connectors.py`
- Modify: `backend/app/services/scheduler.py`

Add Linear to connector status and sync endpoints.

---

## Task 9: Update Flutter Dashboard

**Files:**
- Modify: `frontend/lib/models/dora_metrics.dart` â†’ rename to `metrics.dart`
- Create: `frontend/lib/models/development_metrics.dart`
- Modify: `frontend/lib/services/metrics_service.dart`
- Modify: `frontend/lib/screens/dashboard_screen.dart`

**New KPIs:**
- PR Review Time (avg)
- Cycle Time (avg)
- Throughput (PRs/week)

---

## Task 10: Add Period Selector Widget

**Files:**
- Create: `frontend/lib/widgets/period_selector.dart`
- Modify: `frontend/lib/screens/dashboard_screen.dart`

Allow user to select: Last 7 days, 30 days, 90 days, custom range.

---

## Summary

v0.4 delivers:
1. **Linear Integration**: Teams, Issues with state tracking
2. **PR-Issue Linking**: Automatic via branch name/title parsing
3. **Development Metrics**: PR Review Time, Merge Time, Cycle Time, Throughput
4. **Enhanced Dashboard**: 4+ KPI cards, period selector

Next version (v0.5) will polish charts, trends, filtering, and error handling.
